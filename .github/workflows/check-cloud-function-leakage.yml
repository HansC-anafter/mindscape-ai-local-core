name: Check Cloud Function Leakage

on:
  pull_request:
    paths:
      - 'backend/**'
      - 'web-console/**'
      - 'backend/playbooks/**'

jobs:
  check-cloud-leakage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Check for IG Posts API in Local-Core
        run: |
          if grep -r "ig_posts" backend/app/routes/core/ backend/app/main.py 2>/dev/null; then
            echo "ERROR: IG Posts API found in Local-Core backend!"
            echo "IG Posts is a Cloud capability and must be in mindscape-ai-cloud repo"
            exit 1
          fi

      - name: Check for IG UI components in Local-Core
        run: |
          if find web-console/src -name "*IG*" -type f | grep -E "(IGGridView|IGPostCard|IGTimeline)" 2>/dev/null; then
            echo "ERROR: IG UI components found in Local-Core!"
            echo "IG UI components are Cloud features and must be in mindscape-ai-cloud repo"
            exit 1
          fi

      - name: Check for IG Posts SDK in Local-Core
        run: |
          if grep -r "listIGPosts\|scheduleIGPost" web-console/src/services/localCore/ 2>/dev/null; then
            echo "ERROR: IG Posts SDK methods found in Local-Core!"
            echo "IG Posts SDK is Cloud-specific and must be in mindscape-ai-cloud repo"
            exit 1
          fi

      - name: Check for IG playbooks in Local-Core
        run: |
          if find backend/playbooks/specs -name "*ig_post_generation*" -type f 2>/dev/null; then
            echo "ERROR: IG post generation playbook found in Local-Core!"
            echo "IG post generation is a Cloud capability and must be in mindscape-ai-cloud/capabilities/ig/playbooks/specs/"
            echo "Local-Core should not contain Cloud-specific business playbooks"
            exit 1
          fi

      - name: Check OutcomesPanel for IG logic
        run: |
          if grep -E "IGGridViewModal|hasIGPosts|View IG Posts" web-console/src/app/workspaces/\[workspaceId\]/components/OutcomesPanel.tsx 2>/dev/null; then
            echo "ERROR: IG Posts logic found in OutcomesPanel!"
            echo "IG Posts UI should be provided by Cloud, not embedded in Local-Core"
            exit 1
          fi

      - name: Check for Cloud playbook specs in Local-Core
        run: |
          # Check for any cloud-specific playbook specs that should not be in Local-Core
          FORBIDDEN_PLAYBOOKS=("ig_post_generation" "facebook_post" "twitter_post" "linkedin_post")
          for playbook in "${FORBIDDEN_PLAYBOOKS[@]}"; do
            if find backend/playbooks/specs -name "*${playbook}*" -type f 2>/dev/null | grep -q .; then
              echo "ERROR: Cloud playbook spec '${playbook}' found in Local-Core!"
              echo "Cloud playbook specs should be in mindscape-ai-cloud/capabilities/, not in Local-Core"
              echo "Local-Core should load them via CloudExtensionManager, not store them locally"
              exit 1
            fi
          done

      - name: Check for modifications to protected paths
        run: |
          # Check if PR modifies protected paths that should rarely change
          PROTECTED_PATHS=(
            "backend/playbooks/specs/"
            "backend/app/routes/core/"
            "web-console/src/services/localCore/"
          )

          CHANGED_FILES=$(git diff --name-only origin/master...HEAD 2>/dev/null || git diff --name-only HEAD~1...HEAD 2>/dev/null || echo "")

          if [ -n "$CHANGED_FILES" ]; then
            for path in "${PROTECTED_PATHS[@]}"; do
              if echo "$CHANGED_FILES" | grep -q "^${path}"; then
                echo "WARNING: Modified protected path: ${path}"
                echo "Please ensure this change does not introduce Cloud business logic into Local-Core"
                echo "If this is a Cloud capability, it should be in mindscape-ai-cloud repo"
              fi
            done
          fi

