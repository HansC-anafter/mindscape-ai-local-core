{
  "version": "1.0",
  "playbook_code": "unsplash_visual_lens_extraction",
  "kind": "user_workflow",
  "steps": [
    {
      "id": "expand_keywords",
      "tool": "core_llm.structured_extract",
      "inputs": {
        "text": "Theme: {{input.theme_keywords}}\nStyle Preferences: {{input.style_preferences}}\n\nPlease generate Unsplash image search keywords, including:\n- Core theme words (3-5)\n- Scene words (2-4)\n- Emotion words (2-3)\n- Style words (2-3)",
        "schema_description": "A JSON object with properties: core_themes (array of strings), scenes (array of strings), emotions (array of strings), styles (array of strings)"
      },
      "outputs": {
        "search_keywords": "extracted_data"
      }
    },
    {
      "id": "search_photos",
      "tool": "unsplash.unsplash_search_photos",
      "inputs": {
        "workspace_id": "{{input.workspace_id}}",
        "query": "{{step.expand_keywords.core_themes[0]}} {{step.expand_keywords.core_themes[1]}} {{step.expand_keywords.styles[0]}}",
        "per_page": 30,
        "order_by": "relevance"
      },
      "outputs": {
        "photos": "results"
      },
      "depends_on": ["expand_keywords"]
    },
    {
      "id": "download_images",
      "tool": "unsplash.download_temp_image",
      "for_each": "step.search_photos.photos",
      "inputs": {
        "image_url": "{{item.urls.regular}}",
        "photo_id": "{{item.id}}",
        "workspace_id": "{{input.workspace_id}}"
      },
      "outputs": {
        "temp_path": "temp_path"
      },
      "depends_on": ["search_photos"]
    },
    {
      "id": "extract_features",
      "tool": "mind_lens.mind_lens_extract_features",
      "for_each": "step.download_images.results",
      "inputs": {
        "image_path": "{{item.temp_path}}",
        "include_mood": true
      },
      "outputs": {
        "features": ""
      },
      "depends_on": ["download_images"]
    },
    {
      "id": "generate_feature_summary",
      "tool": "core_llm.structured_extract",
      "inputs": {
        "text": "Analyze the extracted image features and generate a comprehensive statistical summary.\n\n=== EXTRACTED FEATURES ===\n{{step.extract_features.results}}\n\n=== THEME KEYWORDS ===\n{{input.theme_keywords}}\n\n=== STYLE PREFERENCES ===\n{{input.style_preferences}}\n\n=== ANALYSIS REQUIREMENTS ===\n1. Color Analysis:\n   - Extract all color values from features and calculate average/main colors\n   - Convert colors to HEX format (#RRGGBB)\n   - Calculate saturation range (min-max, 0-1)\n   - Calculate contrast range (min-max ratio)\n   - Identify color_temperature (warm/cool/neutral)\n\n2. Composition Analysis:\n   - Identify common composition types from features\n   - Calculate average whitespace_ratio (0-1)\n   - Extract subject_position preferences (rule-of-thirds, center, etc.)\n   - Extract horizon_position preferences (upper-third, lower-third, center)\n   - Identify geometry_preference (symmetry, asymmetry, etc.)\n\n3. Style Analysis:\n   - Identify main visual styles from features\n   - Calculate style consistency score\n   - Extract themes for image vocabulary\n   - Identify distances (close-up, medium, wide)\n   - Identify angles (eye-level, bird's-eye, worm's-eye)\n   - Identify depth_of_field (shallow, deep)\n   - Identify dynamics (static, motion)\n\n4. Mood Analysis:\n   - Extract emotion_keywords from features and theme\n   - Identify narrative_distance (observer, participant, intimate-first-person)\n   - Analyze rhythm (fast, slow, steady)\n\nIMPORTANT: Extract ALL available data from features. Use arrays for multiple values. Calculate statistical averages/ranges where applicable.",
        "schema_description": "JSON object with: color_analysis (object with main_colors:string[] HEX, saturation_range:string min-max, contrast_range:string min-max, color_temperature:string), composition_analysis (object with common_composition_types:string[], whitespace_ratio_range:string min-max, subject_position_preferences:string[], horizon_position_preferences:string[], geometry_preferences:string[]), style_analysis (object with main_styles:string[], style_consistency:float, themes:string[], distances:string[], angles:string[], depth_of_field:string[], dynamics:string[]), mood_analysis (object with emotion_keywords:string[], narrative_distance:string, rhythm:string). All array fields must be arrays, not null."
      },
      "outputs": {
        "feature_summary": "extracted_data"
      },
      "depends_on": ["extract_features"]
    },
    {
      "id": "generate_lens_schema",
      "tool": "core_llm.structured_extract",
      "inputs": {
        "text": "Generate a complete WebVisualLensSchema JSON object based on the following data:\n\n=== FEATURE SUMMARY ===\n{{step.generate_feature_summary.feature_summary}}\n\n=== THEME KEYWORDS ===\n{{input.theme_keywords}}\n\n=== STYLE PREFERENCES ===\n{{input.style_preferences}}\n\n=== LENS NAME ===\n{{input.lens_name}}\n\n=== SOURCE PHOTOS ===\n{{step.search_photos.photos}}\n\n=== INSTRUCTIONS ===\n1. Generate lens_id: 'unsplash_' + lens_name (lowercase, spaces to underscores)\n2. Extract source_images: Array of URLs from photos[].urls.regular\n3. Extract source_image_references: Complete photo objects from photos array\n4. From feature_summary.color_analysis: Extract color_palette (HEX format #RRGGBB), saturation (0-1), contrast_level\n5. From feature_summary.composition_analysis: Extract whitespace_ratio (0-1), subject_position, horizon_position, geometry_preference\n6. From feature_summary.style_analysis: Extract themes for image_vocabulary.themes\n7. From feature_summary.mood_analysis: Extract emotion_keywords, narrative_distance, rhythm\n8. Infer image_vocabulary: distances, angles, depth_of_field, dynamics from feature analysis\n9. Infer web_translation_rules: hero_image_preference, image_text_ratio, layout_density, border_radius, shadow_style, noise_texture, animation_rhythm from style\n10. Infer style_guardrails: forbidden_elements, required_elements from style preferences\n\nIMPORTANT: Fill ALL fields. Use empty arrays [] instead of null for lists. Use reasonable defaults for optional fields. Do not leave fields as null unless explicitly required.",
        "schema_description": "WebVisualLensSchema JSON object with required fields: lens_id (string), name (string), description (string), source_photographer (string|null), source_images (string[]), source_image_references (object[] with photo_id, urls, photographer, etc.), image_vocabulary (object with themes:string[], distances:string[], angles:string[], depth_of_field:string[], dynamics:string[]), composition_rules (object with whitespace_ratio:float 0-1, subject_position:string|null, horizon_position:string|null, geometry_preference:string[]), light_color_tokens (object with color_temperature:string|null, contrast_level:string|null, saturation:float 0-1, color_palette:string[] HEX colors, forbidden_colors:string[] HEX colors), mood_narrative (object with emotion_keywords:string[], narrative_distance:string|null, rhythm:string|null), web_translation_rules (object with hero_image_preference:string[], image_text_ratio:string, layout_density:string, border_radius:string|null, shadow_style:string|null, noise_texture:boolean|null, animation_rhythm:string), style_guardrails (object with forbidden_elements:string[], required_elements:string[]). All array fields must be arrays (not null). Optional string fields can be null, but prefer meaningful values."
      },
      "outputs": {
        "lens_data": "extracted_data"
      },
      "depends_on": ["generate_feature_summary", "search_photos"]
    },
    {
      "id": "create_visual_lens",
      "tool": "visual_lens.visual_lens_create",
      "inputs": {
        "workspace_id": "{{input.workspace_id}}",
        "lens_data": "{{step.generate_lens_schema.lens_data}}"
      },
      "outputs": {
        "saved_lens": ""
      },
      "depends_on": ["generate_lens_schema", "search_photos"]
    }
  ],
  "inputs": {
    "theme_keywords": {
      "type": "list[string]",
      "required": true,
      "description": "Theme keywords for Unsplash search (e.g., ['yoga', 'travel', 'health products'])"
    },
    "style_preferences": {
      "type": "list[string]",
      "required": true,
      "description": "Style preferences for filtering results (e.g., ['minimalist', 'documentary', 'still life'])"
    },
    "lens_name": {
      "type": "string",
      "required": true,
      "description": "Name for the generated Visual Lens (e.g., 'Minimalist Yoga Style')"
    },
    "photographer_mode": {
      "type": "string",
      "default": "single",
      "description": "Photographer mode: 'single' or 'multiple'"
    }
  },
  "outputs": {
    "saved_lens": {
      "type": "object",
      "description": "Saved Visual Lens information",
      "source": "step.create_visual_lens.saved_lens"
    },
    "search_keywords": {
      "type": "object",
      "description": "Expanded search keywords",
      "source": "step.expand_keywords.search_keywords"
    },
    "photos": {
      "type": "list[object]",
      "description": "Unsplash search results",
      "source": "step.search_photos.photos"
    }
  }
}

