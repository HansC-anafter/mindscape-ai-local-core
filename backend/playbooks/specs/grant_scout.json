{
  "version": "1.0.0",
  "playbook_code": "grant_scout",
  "kind": "user_workflow",
  "description": "Discover and match government grant programs for your project",

  "inputs": {
    "action": {
      "type": "string",
      "enum": ["index", "match", "draft"],
      "required": true,
      "description": "Action to perform: index (index grants), match (match grants to project), draft (generate application draft)"
    },
    "user_input": {
      "type": "string",
      "required": false,
      "description": "Project description (required for match action)"
    },
    "grant_id": {
      "type": "string",
      "required": false,
      "description": "Grant ID (required for draft action)"
    },
    "sources": {
      "type": "array",
      "default": ["data.gov.tw"],
      "description": "Data sources to index (for index action)"
    },
    "vault_path": {
      "type": "string",
      "default": "vault",
      "description": "Path to Grant Vault"
    }
  },

  "steps": [
    {
      "id": "index_grants",
      "tool": "grant_scout.index_grants",
      "inputs": {
        "sources": "{{input.sources}}",
        "vault_path": "{{input.vault_path}}",
        "deep_parse": false
      },
      "outputs": {
        "indexed_count": "indexed_count",
        "failed_count": "failed_count",
        "sources": "sources",
        "timestamp": "timestamp"
      },
      "condition": "{{input.action == 'index'}}"
    },
    {
      "id": "build_project_profile",
      "tool": "core_llm.structured_extract",
      "inputs": {
        "text": "{{input.user_input}}",
        "schema_description": "Extract: project_goal, product_stage, industry, tech_keywords, company_profile (company_type, establishment_years, employee_count, capital), budget_need, timeline, location, what_you_can_prove"
      },
      "outputs": {
        "project_profile": "extracted_data"
      },
      "condition": "{{input.action == 'match'}}"
    },
    {
      "id": "recall_candidates",
      "tool": "grant_scout.recall_candidates",
      "inputs": {
        "project_profile": "{{step.build_project_profile.extracted_data}}",
        "vault_path": "{{input.vault_path}}",
        "top_k": 20
      },
      "outputs": {
        "candidates": "candidates",
        "total_count": "total_count"
      },
      "condition": "{{input.action == 'match'}}",
      "depends_on": ["build_project_profile"]
    },
    {
      "id": "match_grants",
      "tool": "grant_scout.match_grants",
      "inputs": {
        "candidates": "{{step.recall_candidates.candidates}}",
        "project_profile": "{{step.build_project_profile.extracted_data}}",
        "vault_path": "{{input.vault_path}}",
        "top_k": 10
      },
      "outputs": {
        "matched_grants": "matched_grants",
        "total_candidates": "total_candidates",
        "eligible_count": "eligible_count"
      },
      "condition": "{{input.action == 'match'}}",
      "depends_on": ["recall_candidates", "build_project_profile"]
    },
    {
      "id": "generate_draft",
      "tool": "grant_scout.generate_draft",
      "inputs": {
        "grant_id": "{{input.grant_id}}",
        "project_profile": "{{step.build_project_profile.extracted_data}}",
        "vault_path": "{{input.vault_path}}"
      },
      "outputs": {
        "strategy_card": "strategy_card",
        "outline": "outline",
        "todos": "todos"
      },
      "condition": "{{input.action == 'draft'}}",
      "depends_on": ["build_project_profile"]
    }
  ],

  "outputs": {
    "index_result": {
      "type": "object",
      "description": "Grant indexing result",
      "source": "step.index_grants"
    },
    "matched_grants": {
      "type": "list[object]",
      "description": "Matched grant programs",
      "source": "step.match_grants.matched_grants"
    },
    "application_draft": {
      "type": "object",
      "description": "Application draft and strategy",
      "source": "step.generate_draft"
    }
  },

  "output_artifacts": [
    {
      "id": "index_result",
      "artifact_type": "grant_index_result",
      "title_template": "Grant Indexing Result",
      "source": "step.index_grants",
      "condition": "{{input.action == 'index'}}"
    },
    {
      "id": "grant_match_results",
      "artifact_type": "grant_match",
      "title_template": "Grant Match Results",
      "source": "step.match_grants.matched_grants",
      "condition": "{{input.action == 'match'}}"
    },
    {
      "id": "application_draft",
      "artifact_type": "grant_application",
      "title_template": "Application Strategy - {{input.grant_id}}",
      "source": "step.generate_draft",
      "condition": "{{input.action == 'draft'}}"
    }
  ]
}

