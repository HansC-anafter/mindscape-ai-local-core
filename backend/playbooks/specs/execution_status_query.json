{
  "version": "1.0",
  "playbook_code": "execution_status_query",
  "kind": "system_tool",
  "steps": [
    {
      "id": "extract_query_intent",
      "tool": "core_llm.structured",
      "inputs": {
        "prompt": "Extract execution query intent from user message. Identify execution_id, playbook_code, or task description.",
        "schema": {
          "type": "object",
          "properties": {
            "execution_id": {
              "type": "string",
              "description": "Execution ID if mentioned"
            },
            "playbook_code": {
              "type": "string",
              "description": "Playbook code if mentioned"
            },
            "task_description": {
              "type": "string",
              "description": "Task description if mentioned"
            },
            "query_type": {
              "type": "string",
              "enum": ["single", "multiple", "all"],
              "description": "Type of query: single execution, multiple, or all"
            }
          }
        },
        "user_message": "{{input.user_message}}",
        "conversation_context": "{{input.conversation_context}}"
      },
      "outputs": {
        "intent": "execution_id",
        "playbook_code": "playbook_code",
        "task_description": "task_description",
        "query_type": "query_type"
      }
    },
    {
      "id": "find_candidate_executions",
      "tool": "workspace_list_executions",
      "inputs": {
        "workspace_id": "{{input.workspace_id}}",
        "status": ["pending", "running"],
        "playbook_code": "{{step.extract_query_intent.playbook_code}}",
        "limit": 20
      },
      "outputs": {
        "executions": "executions"
      },
      "depends_on": ["extract_query_intent"]
    },
    {
      "id": "pick_target_execution",
      "tool": "workspace_pick_relevant_execution",
      "inputs": {
        "candidates": "{{step.find_candidate_executions.executions}}",
        "user_query": "{{input.user_message}}",
        "conversation_context": "{{input.conversation_context}}",
        "extracted_intent": "{{step.extract_query_intent}}"
      },
      "outputs": {
        "execution_id": "execution_id"
      },
      "depends_on": ["find_candidate_executions"]
    },
    {
      "id": "query_execution_status",
      "tool": "workspace_get_execution",
      "inputs": {
        "execution_id": "{{step.pick_target_execution.execution_id}}",
        "workspace_id": "{{input.workspace_id}}"
      },
      "outputs": {
        "execution": "execution"
      },
      "depends_on": ["pick_target_execution"]
    },
    {
      "id": "get_execution_steps",
      "tool": "workspace_get_execution_steps",
      "inputs": {
        "execution_id": "{{step.pick_target_execution.execution_id}}",
        "workspace_id": "{{input.workspace_id}}"
      },
      "outputs": {
        "steps": "steps"
      },
      "depends_on": ["pick_target_execution"]
    },
    {
      "id": "summarize_execution_status",
      "tool": "core_llm.structured",
      "inputs": {
        "prompt": "Summarize execution status into structured format. Extract progress, current step, errors, and last_updated_at from execution and steps data.",
        "schema": {
          "type": "object",
          "properties": {
            "execution_id": {"type": "string"},
            "playbook_code": {"type": "string"},
            "status": {
              "type": "string",
              "enum": ["pending", "running", "succeeded", "failed", "cancelled"]
            },
            "progress": {
              "type": "number",
              "minimum": 0,
              "maximum": 1,
              "description": "Progress from 0 to 1"
            },
            "current_step_name": {"type": "string"},
            "current_step_index": {"type": "integer"},
            "total_steps": {"type": "integer"},
            "last_error": {
              "type": "string",
              "description": "Last error message if any"
            },
            "estimated_remaining_time": {
              "type": "string",
              "description": "Estimated remaining time"
            },
            "last_updated_at": {
              "type": "string",
              "format": "date-time",
              "description": "ISO datetime of last update. Source: execution.updated_at or last step event timestamp. Used for UI 'updated X seconds ago' display and stuck detection."
            }
          }
        },
        "execution": "{{step.query_execution_status.execution}}",
        "steps": "{{step.get_execution_steps.steps}}"
      },
      "outputs": {
        "summary": "summary"
      },
      "depends_on": ["query_execution_status", "get_execution_steps"]
    },
    {
      "id": "generate_status_report",
      "tool": "core_llm.generate",
      "inputs": {
        "prompt": "Generate a natural language status report based on the structured summary. Be user-friendly and specific about progress, current step, and any issues.",
        "summary": "{{step.summarize_execution_status.summary}}",
        "user_query": "{{input.user_message}}",
        "execution_details": "{{step.query_execution_status.execution}}"
      },
      "outputs": {
        "report": "report"
      },
      "depends_on": ["summarize_execution_status"]
    }
  ],
  "inputs": {
    "user_message": {
      "type": "string",
      "required": true,
      "description": "User's query message"
    },
    "workspace_id": {
      "type": "string",
      "required": true,
      "description": "Workspace ID"
    },
    "conversation_context": {
      "type": "string",
      "default": "",
      "description": "Conversation context for better execution selection"
    },
    "execution_id": {
      "type": "string",
      "default": null,
      "description": "Direct execution ID if provided (skips candidate selection)"
    }
  },
  "outputs": {
    "summary": {
      "type": "object",
      "description": "Structured execution status summary (for machine use)",
      "source": "step.summarize_execution_status.summary"
    },
    "report": {
      "type": "string",
      "description": "Natural language status report (for human reading)",
      "source": "step.generate_status_report.report"
    },
    "execution_id": {
      "type": "string",
      "description": "Queried execution ID",
      "source": "step.pick_target_execution.execution_id"
    }
  }
}

