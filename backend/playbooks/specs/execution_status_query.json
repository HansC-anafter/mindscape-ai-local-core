{
  "version": "1.0",
  "playbook_code": "execution_status_query",
  "kind": "system_tool",
  "steps": [
    {
      "id": "extract_query_intent",
      "tool": "core_llm.structured_extract",
      "inputs": {
        "text": "User message: {{input.user_message}}\n\nConversation context: {{input.conversation_context}}\n\nExtract execution query intent from the user message above. Identify execution_id, playbook_code, or task description.",
        "schema_description": "A JSON object with the following properties: 1) execution_id: string (Execution ID if mentioned). 2) playbook_code: string (Playbook code if mentioned). 3) task_description: string (Task description if mentioned). 4) query_type: string, one of 'single', 'multiple', or 'all' (Type of query: single execution, multiple, or all)."
      },
      "outputs": {
        "intent": "extracted_data.execution_id",
        "playbook_code": "extracted_data.playbook_code",
        "task_description": "extracted_data.task_description",
        "query_type": "extracted_data.query_type"
      }
    },
    {
      "id": "find_candidate_executions",
      "tool": "workspace_list_executions",
      "inputs": {
        "workspace_id": "{{input.workspace_id}}",
        "status": ["pending", "running"],
        "playbook_code": "{{step.extract_query_intent.playbook_code}}",
        "limit": 20
      },
      "outputs": {
        "executions": "executions"
      },
      "depends_on": ["extract_query_intent"]
    },
    {
      "id": "pick_target_execution",
      "tool": "workspace_pick_relevant_execution",
      "inputs": {
        "candidates": "{{step.find_candidate_executions.executions}}",
        "user_query": "{{input.user_message}}",
        "conversation_context": "{{input.conversation_context}}",
        "extracted_intent": "{{step.extract_query_intent}}"
      },
      "outputs": {
        "execution_id": "execution_id"
      },
      "depends_on": ["find_candidate_executions"]
    },
    {
      "id": "query_execution_status",
      "tool": "workspace_get_execution",
      "inputs": {
        "execution_id": "{{step.pick_target_execution.execution_id}}",
        "workspace_id": "{{input.workspace_id}}"
      },
      "outputs": {
        "execution": "execution"
      },
      "depends_on": ["pick_target_execution"]
    },
    {
      "id": "get_execution_steps",
      "tool": "workspace_get_execution_steps",
      "inputs": {
        "execution_id": "{{step.pick_target_execution.execution_id}}",
        "workspace_id": "{{input.workspace_id}}"
      },
      "outputs": {
        "steps": "steps"
      },
      "depends_on": ["pick_target_execution"]
    },
    {
      "id": "summarize_execution_status",
      "tool": "core_llm.structured_extract",
      "inputs": {
        "text": "Execution data: {{step.query_execution_status.execution}}\n\nSteps data: {{step.get_execution_steps.steps}}\n\nSummarize execution status into structured format. Extract progress, current step, errors, and last_updated_at from the execution and steps data above.",
        "schema_description": "A JSON object with the following properties: 1) execution_id: string. 2) playbook_code: string. 3) status: string, one of 'pending', 'running', 'succeeded', 'failed', 'cancelled'. 4) progress: number between 0 and 1 (Progress from 0 to 1). 5) current_step_name: string. 6) current_step_index: integer. 7) total_steps: integer. 8) last_error: string (Last error message if any). 9) estimated_remaining_time: string (Estimated remaining time). 10) last_updated_at: string in ISO datetime format (Source: execution.updated_at or last step event timestamp. Used for UI 'updated X seconds ago' display and stuck detection)."
      },
      "outputs": {
        "summary": "extracted_data"
      },
      "depends_on": ["query_execution_status", "get_execution_steps"]
    },
    {
      "id": "generate_status_report",
      "tool": "core_llm.generate",
      "inputs": {
        "prompt": "Generate a natural language status report based on the following structured summary. Be user-friendly and specific about progress, current step, and any issues.\n\nStructured Summary: {{step.summarize_execution_status.summary}}\n\nUser's original query: {{input.user_message}}\n\nExecution details: {{step.query_execution_status.execution}}"
      },
      "outputs": {
        "report": "text"
      },
      "depends_on": ["summarize_execution_status"]
    }
  ],
  "inputs": {
    "user_message": {
      "type": "string",
      "required": true,
      "description": "User's query message"
    },
    "workspace_id": {
      "type": "string",
      "required": true,
      "description": "Workspace ID"
    },
    "conversation_context": {
      "type": "string",
      "default": "",
      "description": "Conversation context for better execution selection"
    },
    "execution_id": {
      "type": "string",
      "default": null,
      "description": "Direct execution ID if provided (skips candidate selection)"
    }
  },
  "outputs": {
    "summary": {
      "type": "object",
      "description": "Structured execution status summary (for machine use)",
      "source": "step.summarize_execution_status.summary"
    },
    "report": {
      "type": "string",
      "description": "Natural language status report (for human reading)",
      "source": "step.generate_status_report.report"
    },
    "execution_id": {
      "type": "string",
      "description": "Queried execution ID",
      "source": "step.pick_target_execution.execution_id"
    }
  }
}

